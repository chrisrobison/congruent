
<!DOCTYPE html>
<html>
<head>
   <title></title>
   <style>
      body { background-color:#000; padding:0; margin:0; }
      .token {
         display:inline-block;
         border-radius:3em;
         border: 6px solid transparent;
         transition: transform 600ms;
         position:absolute;
         background-size:cover;
         background-repeat: no-repeat;
         background-position: 0 0;
         background-image: url("button.png");
      }
      .selected {
         border-color:#fff;
      }
      .remove {
         transform: scale(0);
         opacity:0;
      }
      .gem1 { background-color:#990000; }
      .gem2 { background-color:#009900; }
      .gem3 { background-color:#000099; }
      .gem4 { background-color:#999900; }
      .gem5 { background-color:#009999; }
      .gem6 { background-color:#990099; }
         
      .selected.gem1 { background-color:#ff0000; }
      .selected.gem2 { background-color:#00ff00; }
      .selected.gem3 { background-color:#0000ff; }
      .selected.gem4 { background-color:#ffff00; }
      .selected.gem5 { background-color:#00ffff; }
      .selected.gem6 { background-color:#ff00ff; }
      div.explode {
         background-image:url("poof.gif");
         height:46px;
         width:60px;
         border:none;
         border-radius:0;
         overflow:visible;
         background-position:-11px;
         margin-left:8px;
         margin-top:4px;
      }
      div.poof {
         background-image: url(poof.png);
         background-color:transparent;
         width: 60px;
         height: 60px;
         animation: play 500ms steps(7) 1;
      }
      @keyframes play {
         from { background-position:    0px; }
         to { background-position: -420px; }
      }
</style>
</head>
<body>
<div id="board"></div>
<script>
(function() {
   window.cdr = {
      config: {
         wide:20,
         border:4,
         colors: ["transparent","#990000", "#999900", "#009900", "#000099", "#990099", "#009999", "#999999", "#ee9900"],
         drkclr: ["#000000","#660000", "#666600", "#006600", "#000066", "#660066", "#006666", "#666666", "#996600"],
         lgtclr: ["#444445","#ff0000", "#ffff00", "#00ff00", "#0000ff", "#ff00ff", "#00ffff", "#ffffff", "#ffaa00"],
         color: function(c) { return "#" + 'e00ee00e009ee0e0ee335900990090039909099000'.substr(c * 3, 3); },
         difficulty: 5
      },
      state: {
         rows: 0,
         cols: 0,
         board: [],
         selected: [],
         matches: []
      },
      init: function() {
         cdr.config.size = Math.floor(window.innerWidth/cdr.config.wide);
         cdr.config.tall = Math.floor(window.innerHeight/cdr.config.size);
         cdr.state.cols = cdr.config.wide;
         cdr.state.rows = cdr.config.tall;

         document.addEventListener("click", cdr.handleClick);
         cdr.newGame();
      }, 
      newGame: function() {
         cdr.state.board = cdr.genBoard();
         cdr.fillBoard(cdr.state.board);
      },
      genBoard: function() {
         for (var r=0; r<cdr.config.tall; r++) {
            cdr.state.board[r] = [];
            for (var c=0; c<cdr.config.wide; c++) {
               cdr.state.board[r][c] = Math.round(Math.random()*(cdr.config.difficulty))+1;
            }
         }
         return cdr.state.board;
      },
      makeGem: function(id, color) {
         var el = document.createElement("div");
            el.classList.add("token");
            el.classList.add("gem"+color);
            if (color<0) {
               el.style.backgroundColor = cdr.config.lgtclr[Math.abs(color)];
               el.style.borderColor = "#fff"; // cdr.config.colors[Math.abs(cdr.state.board[r][c])];
            } else {
               el.style.backgroundColor = cdr.config.colors[Math.abs(color)];
               el.style.borderColor = "#000"; //cdr.config.drkclr[cdr.state.board[r][c]];
               if (color==0) {
                  el.style.backgroundImage = "none";
               }
            }
            el.style.borderWidth = cdr.config.border + "px";
            var p = cdr.rowcol(id);
            el.style.top = cdr.config.size * p[0] + "px";
            el.style.left = cdr.config.size * p[1] + "px";
            el.style.height = cdr.config.size - (cdr.config.border * 2) + "px";
            el.style.width = cdr.config.size - (cdr.config.border * 2) + "px";
            el.id = "r" + p[0] + "c" + p[1];
            
            return el;
      },
      fillBoard: function(board) {
         var g = $$("board");
         g.innerHTML = "";
         for (var r=0; r<cdr.config.tall; r++) {
            for (var c=0; c<cdr.config.wide; c++) {
               var el = cdr.makeGem("r"+r+"c"+c, cdr.state.board[r][c]);
               if (cdr.state.board[r][c]!=0) g.appendChild(el);
            }
         }
      },
      rowcol: function(str) {
         var match = str.match(/r(\d+)c(\d+)/);

         if (match) {
            return [parseInt(match[1]), parseInt(match[2])];
         } else {
            return false;
         }
      },
      handleClick: function(event) {
         var who = event.target,
             m = cdr.rowcol(who.id);
             console.dir(cdr.state.matches);
         
         if (!m) return false;    
         if (cdr.state.matches.length) {
            if (cdr.checkMatches(who.id)) {
               setTimeout(function() { cdr.checkCols(); }, 600);
               setTimeout(function() { cdr.checkRows(); }, 800);
               setTimeout(function() { cdr.fillBoard(cdr.state.board); }, 1500); 
            } else {
               cdr.clearMatches();
            }
         }  else {
            cdr.findMatches(who.id, cdr.state.board[m[0]][m[1]]);
            setTimeout(function() {
               if (cdr.state.matches.length <= 1) {
                  cdr.clearMatches();
               }
            }, 40);
         }
      },
      checkMatches: function(who) {
         var matched = false;
         if (cdr.state.matches.includes(who)) {
            cdr.removeMatches();
            cdr.clearMatches();
            // setTimeout(function() { cdr.fillBoard(cdr.state.board); }, 1000);
            cdr.state.matches = [];
            matched = true;
         }
         return matched;
      },
      checkRows: function() {
         for (var r=0; r<cdr.state.rows; r++) {
            var results = cdr.checkRow(r);
         }
      },
      checkRow: function(r) {
         var row = cdr.getRow(r),
             rowstr = row.join(''),
             sections = rowstr.match(/([^0]*)(0+)/y),
             el;
         
         if (sections) {
            var cursor = 0;
            for (var m=0; m<sections.length; m++) {
               var s = sections[m];
               var zs = s.match(/(0+)/);
               var z = zs ? zs[1].length : 0;
               
               var start = cursor + s.length;
               
               if (z) {
                  for (c=start; c<cdr.state.cols; c++) {
                     el = $$("r"+r+"c"+c);
                     if (el) {
                        el.style.transform += ` translateX(-${cdr.config.size * z}px)`;
                        el.id = `r${r}c${c-z}`;
                        console.log(`Updated cdr.state.board[${r}][${c-z}] with value from cdr.state.board[${r}][${c}] [${cdr.state.board[r][c]}]`);
                        cdr.state.board[r][c-z] = cdr.state.board[r][c];
                        cdr.state.board[r][c] = 0;
                     }
                  }
               }
               cursor = start;
            }
         }

         return [z, start];
      },
      checkCols: function() {
         for (var c=0; c<cdr.state.cols; c++) {
            var results = cdr.checkCol(c);
         }
      },
      checkCol: function(c) {
         var col = cdr.getCol(c),
             zeros = col.join('').replace(/^0*/,'').replace(/[^0]*/g, '').length,
             el, r;
         var lz = col.lastIndexOf("0");
         var realstart = lz - zeros;
         
         if (zeros) {
         console.log("Column " + c + " needs shifting " + zeros + " spots starting from spot " + realstart); 
         }
         
         for (r=realstart; r>-1; r--) {
            el = $$("r"+r+"c"+c);
            if (el) {
               el.style.transform = "translateY("+cdr.config.size * zeros+"px)";
               el.id = "r"+(r+zeros)+"c"+c;
               cdr.state.board[r+zeros][c] = cdr.state.board[r][c];
               cdr.state.board[r][c] = 0;
            }
         }

         return [zeros, realstart];
      },
      getRow: function(row) {
         var out = [];
         for (var c=0; c < cdr.state.cols; c++) {
            out[c] = cdr.state.board[row][c].toString();
         }
         return out;
      },
      getCol: function(col) {
         var out = [];
         for (var r=0; r < cdr.state.rows; r++) {
            out[r] = cdr.state.board[r][col].toString();
         }
         return out;
      },
      removeMatches: function() {
         for (var i=0; i<cdr.state.matches.length; i++) {
            var p = cdr.state.matches[i].match(/r(\d+)c(\d+)/);
            cdr.state.board[p[1]][p[2]] = 0;
         }

         for (var i=0; i<cdr.state.matches.length; i++) {
            cdr.removePiece(cdr.state.matches[i], i);
         }
         //setTimeout(function() { cdr.fillBoard(cdr.state.board); },1000);
      },
      clearMatches: function() {
         for (var i=0; i<cdr.state.matches.length; i++) {
            var p = cdr.state.matches[i].match(/r(\d+)c(\d+)/);
            var el = $$(cdr.state.matches[i]);
            if (el) {
               el.style.borderColor = "#000"; // cdr.config.drkclr[Math.abs(cdr.state.board[p[1]][p[2]])];
               el.style.backgroundColor = cdr.config.colors[Math.abs(cdr.state.board[p[1]][p[2]])];
               el.classList.remove("selected");
            }
            cdr.state.board[p[1]][p[2]] = Math.abs(cdr.state.board[p[1]][p[2]]);
         }
         cdr.state.matches = [];
      },
      findMatches: function(who, clr) {
         var [r, c] = cdr.rowcol(who);
         if (cdr.state.board[r][c] === clr) {
            cdr.state.board[r][c] *= -1;
            var color = cdr.config.lgtclr[Math.abs(cdr.state.board[r][c])]; 
            cdr.state.matches.push(who);
            
           // Stagger highlighting buttons for nice effect
           setTimeout(function() { cdr.highlight(who, color); }, cdr.state.matches.length * 40);

            if (r < cdr.state.rows-1) cdr.findMatches(`r${r+1}c${c}`, clr);
            if (c < cdr.state.cols-1) cdr.findMatches(`r${r}c${c+1}`, clr);
            if (r > 0) cdr.findMatches(`r${r-1}c${c}`, clr);
            if (c > 0) cdr.findMatches(`r${r}c${c-1}`, clr);
         }    
      },
      highlight: function(who, color) {
         $$(who).classList.add('selected');
         $$(who).style.borderColor = "#fff";
         $$(who).style.backgroundColor = color;
      },
      updateBoard: function() {
         for (var r=0; r<cdr.state.board.length; r++) {
            for (var c=0; c<cdr.state.cols; c++) {
               var elstr = "r" + r + "c" + c;
               var el = $$(elstr);
               if (el) {
                  el.style.top = r * cdr.config.size + "px";
                  el.style.left = c * cdr.config.size + "px";
               } else {
                  el = document.createElement("div");
               }
            }
         }
      },
      explode: function(who) {

      },
      removePiece: function(piece, cnt) {
         var parts = cdr.rowcol(piece);
         setTimeout(function() {
            var el = $$(piece);
            if (el) {
               el.style.backgroundColor = "transparent";
               el.style.zIndex = 99999;
               el.style.border = "none";
               el.classList.add("poof");
               el.style.height="60px";
               el.style.width = "60px";
               el.style.transform = "scale(2)";

            //   el.classList.add("remove");
            //   el.classList.remove("token");
               setTimeout(function() {
            //      el.style.transform = "scale(3)";
                  el.style.opacity = 0;
                   // el.parentNode.removeChild(el);
               }, 600);
            }
         }, 50*cnt);
         cdr.state.board[parts[0]][parts[1]] = 0;
      },
      dumpBoard: function() {
         var out = "";
         for (var r=0; r<cdr.state.board.length; r++) {
            out += "\n";
            for (var c=0; c<cdr.state.board[r].length; c++) {
               out += cdr.state.board[r][c];
            }
         }
         console.log(out);
      }
               
   };
})();
function $$(str) { return document.getElementById(str); }
cdr.init();
</script>
</body>
</html>

